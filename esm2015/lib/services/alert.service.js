// =============================
// Email: info@ebenmonney.com
// www.ebenmonney.com/templates
// =============================
import { Injectable } from '@angular/core';
import { HttpResponseBase } from '@angular/common/http';
import { Subject } from 'rxjs';
import { Utilities } from '@polpware/ngx-appkit-contracts-alpha';
import { DialogType, MessageSeverity } from '@polpware/ngx-appkit-contracts-alpha';
import * as i0 from "@angular/core";
export class AlertService {
    constructor() {
        this.messages = new Subject();
        this.dialogs = new Subject();
    }
    showDialog(message, type, okCallback, cancelCallback, okLabel, cancelLabel, defaultValue) {
        if (!type) {
            type = DialogType.alert;
        }
        this.dialogs.next({ message, type, okCallback, cancelCallback, okLabel, cancelLabel, defaultValue });
    }
    showMessage(data, separatorOrDetail, severity) {
        if (!severity) {
            severity = MessageSeverity.default;
        }
        if (data instanceof HttpResponseBase) {
            data = Utilities.getHttpResponseMessages(data);
            separatorOrDetail = Utilities.captionAndMessageSeparator;
        }
        if (data instanceof Array) {
            for (const message of data) {
                const msgObject = Utilities.splitInTwo(message, separatorOrDetail);
                this.showMessageHelper(msgObject.firstPart, msgObject.secondPart, severity, false);
            }
        }
        else {
            this.showMessageHelper(data, separatorOrDetail, severity, false);
        }
    }
    showStickyMessage(data, separatorOrDetail, severity, error, onRemove) {
        if (!severity) {
            severity = MessageSeverity.default;
        }
        if (data instanceof HttpResponseBase) {
            data = Utilities.getHttpResponseMessages(data);
            separatorOrDetail = Utilities.captionAndMessageSeparator;
        }
        if (data instanceof Array) {
            for (const message of data) {
                const msgObject = Utilities.splitInTwo(message, separatorOrDetail);
                this.showMessageHelper(msgObject.firstPart, msgObject.secondPart, severity, true);
            }
        }
        else {
            if (error) {
                const msg = `Severity: "${MessageSeverity[severity]}", Summary: "${data}", Detail: "${separatorOrDetail}", Error: "${Utilities.safeStringify(error)}"`;
                switch (severity) {
                    case MessageSeverity.default:
                        this.logInfo(msg);
                        break;
                    case MessageSeverity.info:
                        this.logInfo(msg);
                        break;
                    case MessageSeverity.success:
                        this.logMessage(msg);
                        break;
                    case MessageSeverity.error:
                        this.logError(msg);
                        break;
                    case MessageSeverity.warn:
                        this.logWarning(msg);
                        break;
                    case MessageSeverity.wait:
                        this.logTrace(msg);
                        break;
                }
            }
            this.showMessageHelper(data, separatorOrDetail, severity, true, onRemove);
        }
    }
    showMessageHelper(summary, detail, severity, isSticky, onRemove) {
        const alertCommand = {
            operation: isSticky ? 'add_sticky' : 'add',
            message: { severity, summary, detail },
            onRemove
        };
        this.messages.next(alertCommand);
    }
    resetStickyMessage() {
        this.messages.next({ operation: 'clear' });
    }
    startLoadingMessage(message = 'Loading...', caption = '') {
        clearTimeout(this.loadingMessageTimeoutId);
        this.loadingMessageTimeoutId = setTimeout(() => {
            this.showStickyMessage(caption, message, MessageSeverity.wait);
        }, 1000);
    }
    stopLoadingMessage() {
        clearTimeout(this.loadingMessageTimeoutId);
        this.resetStickyMessage();
    }
    logDebug(msg) {
        console.debug(msg);
    }
    logError(msg) {
        console.error(msg);
    }
    logInfo(msg) {
        console.info(msg);
    }
    logMessage(msg) {
        console.log(msg);
    }
    logTrace(msg) {
        console.trace(msg);
    }
    logWarning(msg) {
        console.warn(msg);
    }
    getDialogEvent() {
        return this.dialogs.asObservable();
    }
    getMessageEvent() {
        return this.messages.asObservable();
    }
}
/** @nocollapse */ AlertService.ɵfac = function AlertService_Factory(t) { return new (t || AlertService)(); };
/** @nocollapse */ AlertService.ɵprov = i0.ɵɵdefineInjectable({ token: AlertService, factory: AlertService.ɵfac });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(AlertService, [{
        type: Injectable
    }], null, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwb2xwd2FyZS9uZ3gtYXBwa2l0LXNlcnZpY2VzLWFscGhhLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2FsZXJ0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsZ0NBQWdDO0FBQ2hDLDZCQUE2QjtBQUM3QiwrQkFBK0I7QUFDL0IsZ0NBQWdDO0FBRWhDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFFakUsT0FBTyxFQUlILFVBQVUsRUFDVixlQUFlLEVBQ2xCLE1BQU0sc0NBQXNDLENBQUM7O0FBSTlDLE1BQU0sT0FBTyxZQUFZO0lBRHpCO1FBRVksYUFBUSxHQUFHLElBQUksT0FBTyxFQUFnQixDQUFDO1FBQ3ZDLFlBQU8sR0FBRyxJQUFJLE9BQU8sRUFBZSxDQUFDO0tBbUtoRDtJQTFKRyxVQUFVLENBQUMsT0FBZSxFQUFFLElBQWlCLEVBQUUsVUFBK0IsRUFBRSxjQUEwQixFQUFFLE9BQWdCLEVBQUUsV0FBb0IsRUFBRSxZQUFxQjtRQUVySyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1AsSUFBSSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUM7U0FDM0I7UUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7SUFDekcsQ0FBQztJQVFELFdBQVcsQ0FBQyxJQUFTLEVBQUUsaUJBQTBCLEVBQUUsUUFBMEI7UUFFekUsSUFBSSxDQUFDLFFBQVEsRUFBRTtZ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LENBQUM7SUFFRCxVQUFVLENBQUMsR0FBRztRQUNWLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDckIsQ0FBQztJQUVELFFBQVEsQ0FBQyxHQUFHO1FBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRUQsVUFBVSxDQUFDLEdBQUc7UUFDVixPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxjQUFjO1FBQ1YsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxlQUFlO1FBQ1gsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3hDLENBQUM7OzJGQXBLUSxZQUFZO3VFQUFaLFlBQVksV0FBWixZQUFZO2tEQUFaLFlBQVk7Y0FEeEIsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbIi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBFbWFpbDogaW5mb0BlYmVubW9ubmV5LmNvbVxuLy8gd3d3LmViZW5tb25uZXkuY29tL3RlbXBsYXRlc1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cFJlc3BvbnNlQmFzZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgVXRpbGl0aWVzIH0gZnJvbSAnQHBvbHB3YXJlL25neC1hcHBraXQtY29udHJhY3RzLWFscGhhJztcblxuaW1wb3J0IHtcbiAgICBJQWxlcnRTZXJ2aWNlQ29udHJhY3QsXG4gICAgQWxlcnRDb21tYW5kLFxuICAgIEFsZXJ0RGlhbG9nLFxuICAgIERpYWxvZ1R5cGUsXG4gICAgTWVzc2FnZVNldmVyaXR5XG59IGZyb20gJ0Bwb2xwd2FyZS9uZ3gtYXBwa2l0LWNvbnRyYWN0cy1hbHBoYSc7XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEFsZXJ0U2VydmljZSBpbXBsZW1lbnRzIElBbGVydFNlcnZpY2VDb250cmFjdCB7XG4gICAgcHJpdmF0ZSBtZXNzYWdlcyA9IG5ldyBTdWJqZWN0PEFsZXJ0Q29tbWFuZD4oKTtcbiAgICBwcml2YXRlIGRpYWxvZ3MgPSBuZXcgU3ViamVjdDxBbGVydERpYWxvZz4oKTtcblxuICAgIHByaXZhdGUgbG9hZGluZ01lc3NhZ2VUaW1lb3V0SWQ6IGFueTtcblxuXG5cbiAgICBzaG93RGlhbG9nKG1lc3NhZ2U6IHN0cmluZyk7XG4gICAgc2hvd0RpYWxvZyhtZXNzYWdlOiBzdHJpbmcsIHR5cGU6IERpYWxvZ1R5cGUsIG9rQ2FsbGJhY2s6ICh2YWw/OiBhbnkpID0+IGFueSk7XG4gICAgc2hvd0RpYWxvZyhtZXNzYWdlOiBzdHJpbmcsIHR5cGU6IERpYWxvZ1R5cGUsIG9rQ2FsbGJhY2s/OiAodmFsPzogYW55KSA9PiBhbnksIGNhbmNlbENhbGxiYWNrPzogKCkgPT4gYW55LCBva0xhYmVsPzogc3RyaW5nLCBjYW5jZWxMYWJlbD86IHN0cmluZywgZGVmYXVsdFZhbHVlPzogc3RyaW5nKTtcbiAgICBzaG93RGlhbG9nKG1lc3NhZ2U6IHN0cmluZywgdHlwZT86IERpYWxvZ1R5cGUsIG9rQ2FsbGJhY2s/OiAodmFsPzogYW55KSA9PiBhbnksIGNhbmNlbENhbGxiYWNrPzogKCkgPT4gYW55LCBva0xhYmVsPzogc3RyaW5nLCBjYW5jZWxMYWJlbD86IHN0cmluZywgZGVmYXVsdFZhbHVlPzogc3RyaW5nKSB7XG5cbiAgICAgICAgaWYgKCF0eXBlKSB7XG4gICAgICAgICAgICB0eXBlID0gRGlhbG9nVHlwZS5hbGVydDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGlhbG9ncy5uZXh0KHsgbWVzc2FnZSwgdHlwZSwgb2tDYWxsYmFjaywgY2FuY2VsQ2FsbGJhY2ssIG9rTGFiZWwsIGNhbmNlbExhYmVsLCBkZWZhdWx0VmFsdWUgfSk7XG4gICAgfVxuXG5cblxuICAgIHNob3dNZXNzYWdlKHN1bW1hcnk6IHN0cmluZyk7XG4gICAgc2hvd01lc3NhZ2Uoc3VtbWFyeTogc3RyaW5nLCBkZXRhaWw6IHN0cmluZywgc2V2ZXJpdHk6IE1lc3NhZ2VTZXZlcml0eSk7XG4gICAgc2hvd01lc3NhZ2Uoc3VtbWFyeUFuZERldGFpbHM6IHN0cmluZ1tdLCBzdW1tYXJ5QW5kRGV0YWlsc1NlcGFyYXRvcjogc3RyaW5nLCBzZXZlcml0eTogTWVzc2FnZVNldmVyaXR5KTtcbiAgICBzaG93TWVzc2FnZShyZXNwb25zZTogSHR0cFJlc3BvbnNlQmFzZSwgaWdub3JlVmFsdWVfdXNlTnVsbDogc3RyaW5nLCBzZXZlcml0eTogTWVzc2FnZVNldmVyaXR5KTtcbiAgICBzaG93TWVzc2FnZShkYXRhOiBhbnksIHNlcGFyYXRvck9yRGV0YWlsPzogc3RyaW5nLCBzZXZlcml0eT86IE1lc3NhZ2VTZXZlcml0eSkge1xuXG4gICAgICAgIGlmICghc2V2ZXJpdHkpIHtcbiAgICAgICAgICAgIHNldmVyaXR5ID0gTWVzc2FnZVNldmVyaXR5LmRlZmF1bHQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZUJhc2UpIHtcbiAgICAgICAgICAgIGRhdGEgPSBVdGlsaXRpZXMuZ2V0SHR0cFJlc3BvbnNlTWVzc2FnZXMoZGF0YSk7XG4gICAgICAgICAgICBzZXBhcmF0b3JPckRldGFpbCA9IFV0aWxpdGllcy5jYXB0aW9uQW5kTWVzc2FnZVNlcGFyYXRvcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgbWVzc2FnZSBvZiBkYXRhKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbXNnT2JqZWN0ID0gVXRpbGl0aWVzLnNwbGl0SW5Ud28obWVzc2FnZSwgc2VwYXJhdG9yT3JEZXRhaWwpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5zaG93TWVzc2FnZUhlbHBlcihtc2dPYmplY3QuZmlyc3RQYXJ0LCBtc2dPYmplY3Quc2Vjb25kUGFydCwgc2V2ZXJpdHksIGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc2hvd01lc3NhZ2VIZWxwZXIoZGF0YSwgc2VwYXJhdG9yT3JEZXRhaWwsIHNldmVyaXR5LCBmYWxzZSk7XG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIHNob3dTdGlja3lNZXNzYWdlKHN1bW1hcnk6IHN0cmluZyk7XG4gICAgc2hvd1N0aWNreU1lc3NhZ2Uoc3VtbWFyeTogc3RyaW5nLCBkZXRhaWw6IHN0cmluZywgc2V2ZXJpdHk6IE1lc3NhZ2VTZXZlcml0eSwgZXJyb3I/OiBhbnkpO1xuICAgIHNob3dTdGlja3lNZXNzYWdlKHN1bW1hcnk6IHN0cmluZywgZGV0YWlsOiBzdHJpbmcsIHNldmVyaXR5OiBNZXNzYWdlU2V2ZXJpdHksIGVycm9yPzogYW55LCBvblJlbW92ZT86ICgpID0+IGFueSk7XG4gICAgc2hvd1N0aWNreU1lc3NhZ2Uoc3VtbWFyeUFuZERldGFpbHM6IHN0cmluZ1tdLCBzdW1tYXJ5QW5kRGV0YWlsc1NlcGFyYXRvcjogc3RyaW5nLCBzZXZlcml0eTogTWVzc2FnZVNldmVyaXR5KTtcbiAgICBzaG93U3RpY2t5TWVzc2FnZShyZXNwb25zZTogSHR0cFJlc3BvbnNlQmFzZSwgaWdub3JlVmFsdWVfdXNlTnVsbDogc3RyaW5nLCBzZXZlcml0eTogTWVzc2FnZVNldmVyaXR5KTtcbiAgICBzaG93U3RpY2t5TWVzc2FnZShkYXRhOiBzdHJpbmcgfCBzdHJpbmdbXSB8IEh0dHBSZXNwb25zZUJhc2UsIHNlcGFyYXRvck9yRGV0YWlsPzogc3RyaW5nLCBzZXZlcml0eT86IE1lc3NhZ2VTZXZlcml0eSwgZXJyb3I/OiBhbnksIG9uUmVtb3ZlPzogKCkgPT4gYW55KSB7XG5cbiAgICAgICAgaWYgKCFzZXZlcml0eSkge1xuICAgICAgICAgICAgc2V2ZXJpdHkgPSBNZXNzYWdlU2V2ZXJpdHkuZGVmYXVsdDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlQmFzZSkge1xuICAgICAgICAgICAgZGF0YSA9IFV0aWxpdGllcy5nZXRIdHRwUmVzcG9uc2VNZXNzYWdlcyhkYXRhKTtcbiAgICAgICAgICAgIHNlcGFyYXRvck9yRGV0YWlsID0gVXRpbGl0aWVzLmNhcHRpb25BbmRNZXNzYWdlU2VwYXJhdG9yO1xuICAgICAgICB9XG5cblxuICAgICAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IG1lc3NhZ2Ugb2YgZGF0YSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1zZ09iamVjdCA9IFV0aWxpdGllcy5zcGxpdEluVHdvKG1lc3NhZ2UsIHNlcGFyYXRvck9yRGV0YWlsKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuc2hvd01lc3NhZ2VIZWxwZXIobXNnT2JqZWN0LmZpcnN0UGFydCwgbXNnT2JqZWN0LnNlY29uZFBhcnQsIHNldmVyaXR5LCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgaWYgKGVycm9yKSB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBtc2cgPSBgU2V2ZXJpdHk6IFwiJHtNZXNzYWdlU2V2ZXJpdHlbc2V2ZXJpdHldfVwiLCBTdW1tYXJ5OiBcIiR7ZGF0YX1cIiwgRGV0YWlsOiBcIiR7c2VwYXJhdG9yT3JEZXRhaWx9XCIsIEVycm9yOiBcIiR7VXRpbGl0aWVzLnNhZmVTdHJpbmdpZnkoZXJyb3IpfVwiYDtcblxuICAgICAgICAgICAgICAgIHN3aXRjaCAoc2V2ZXJpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBNZXNzYWdlU2V2ZXJpdHkuZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nSW5mbyhtc2cpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgTWVzc2FnZVNldmVyaXR5LmluZm86XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ0luZm8obXNnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIE1lc3NhZ2VTZXZlcml0eS5zdWNjZXNzOlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dNZXNzYWdlKG1zZyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBNZXNzYWdlU2V2ZXJpdHkuZXJyb3I6XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ0Vycm9yKG1zZyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBNZXNzYWdlU2V2ZXJpdHkud2FybjpcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nV2FybmluZyhtc2cpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgTWVzc2FnZVNldmVyaXR5LndhaXQ6XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ1RyYWNlKG1zZyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuc2hvd01lc3NhZ2VIZWxwZXIoZGF0YSwgc2VwYXJhdG9yT3JEZXRhaWwsIHNldmVyaXR5LCB0cnVlLCBvblJlbW92ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHNob3dNZXNzYWdlSGVscGVyKHN1bW1hcnk6IHN0cmluZywgZGV0YWlsOiBzdHJpbmcsIHNldmVyaXR5OiBNZXNzYWdlU2V2ZXJpdHksIGlzU3RpY2t5OiBib29sZWFuLCBvblJlbW92ZT86ICgpID0+IGFueSkge1xuXG4gICAgICAgIGNvbnN0IGFsZXJ0Q29tbWFuZDogQWxlcnRDb21tYW5kID0ge1xuICAgICAgICAgICAgb3BlcmF0aW9uOiBpc1N0aWNreSA/ICdhZGRfc3RpY2t5JyA6ICdhZGQnLFxuICAgICAgICAgICAgbWVzc2FnZTogeyBzZXZlcml0eSwgc3VtbWFyeSwgZGV0YWlsIH0sXG4gICAgICAgICAgICBvblJlbW92ZVxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMubWVzc2FnZXMubmV4dChhbGVydENvbW1hbmQpO1xuICAgIH1cblxuICAgIHJlc2V0U3RpY2t5TWVzc2FnZSgpIHtcbiAgICAgICAgdGhpcy5tZXNzYWdlcy5uZXh0KHsgb3BlcmF0aW9uOiAnY2xlYXInIH0pO1xuICAgIH1cblxuICAgIHN0YXJ0TG9hZGluZ01lc3NhZ2UobWVzc2FnZSA9ICdMb2FkaW5nLi4uJywgY2FwdGlvbiA9ICcnKSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmxvYWRpbmdNZXNzYWdlVGltZW91dElkKTtcblxuICAgICAgICB0aGlzLmxvYWRpbmdNZXNzYWdlVGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNob3dTdGlja3lNZXNzYWdlKGNhcHRpb24sIG1lc3NhZ2UsIE1lc3NhZ2VTZXZlcml0eS53YWl0KTtcbiAgICAgICAgfSwgMTAwMCk7XG4gICAgfVxuXG4gICAgc3RvcExvYWRpbmdNZXNzYWdlKCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5sb2FkaW5nTWVzc2FnZVRpbWVvdXRJZCk7XG4gICAgICAgIHRoaXMucmVzZXRTdGlja3lNZXNzYWdlKCk7XG4gICAgfVxuXG5cblxuICAgIGxvZ0RlYnVnKG1zZykge1xuICAgICAgICBjb25zb2xlLmRlYnVnKG1zZyk7XG4gICAgfVxuXG4gICAgbG9nRXJyb3IobXNnKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IobXNnKTtcbiAgICB9XG5cbiAgICBsb2dJbmZvKG1zZykge1xuICAgICAgICBjb25zb2xlLmluZm8obXNnKTtcbiAgICB9XG5cbiAgICBsb2dNZXNzYWdlKG1zZykge1xuICAgICAgICBjb25zb2xlLmxvZyhtc2cpO1xuICAgIH1cblxuICAgIGxvZ1RyYWNlKG1zZykge1xuICAgICAgICBjb25zb2xlLnRyYWNlKG1zZyk7XG4gICAgfVxuXG4gICAgbG9nV2FybmluZyhtc2cpIHtcbiAgICAgICAgY29uc29sZS53YXJuKG1zZyk7XG4gICAgfVxuXG4gICAgZ2V0RGlhbG9nRXZlbnQoKTogT2JzZXJ2YWJsZTxBbGVydERpYWxvZz4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kaWFsb2dzLmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIGdldE1lc3NhZ2VFdmVudCgpOiBPYnNlcnZhYmxlPEFsZXJ0Q29tbWFuZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5tZXNzYWdlcy5hc09ic2VydmFibGUoKTtcbiAgICB9XG59XG5cbiJdfQ==